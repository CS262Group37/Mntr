name: Docker Image CI
on: [push]

jobs:
  # Label of the container job
  container-job:
    # Containers must run in Linux based operating systems
    runs-on: ubuntu-latest
    # # Docker Hub image that `container-job` executes in
    # container: python

    # # Service containers to run with `container-job`
    # services:
    #   # Label used to access the service container
    #   postgres:
    #     # Docker Hub image
    #     image: postgres
    #     # Provide the password for postgres
    #     env:
    #       POSTGRES_DB: postgres_db
    #       POSTGRES_PASSWORD: postgres_password
    #       POSTGRES_PORT: 5432
    #       POSTGRES_USER: postgres_user
    #     ports:
    #       # maps tcp port 5432 on service container to the host
    #       - 5432:5432
    #     # Set health checks to wait until postgres has started
    #     options: >-
    #       --health-cmd pg_isready
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 5
    
    # steps:
    #   - uses: actions/checkout@v2
    #   - name: Create .env file
    #     run: |
    #       touch backend/.env
    #       echo FLASK_APP=app >> backend/.env
    #       echo FLASK_ENV=development >> backend/.env
    #       echo DB_USER=postgres_user >> backend/.env
    #       echo DB_HOST=postgres >> backend/.env
    #       echo DB_NAME=postgres_db >> backend/.env
    #       echo DB_PASSWORD=postgres_password >> backend/.env
    #       echo HOSTNAME=http://localhost:5000 >> backend/.env
    #       cat backend/.env
    #   - name: Install dependencies
    #     run: |
    #       python -m pip install --upgrade pip
    #       pip install -r backend/requirements.txt
    #   - name: Run flask server
    #     run: |
    #       cd backend
    #       flask run &
    #   - name: Run tests
    #     run: pytest
    steps:
      - uses: actions/checkout@v2
      - name: Create .env file
        run: |
          touch backend/.env
          echo POSTGRES_USER=postgres >> backend/.env
          echo POSTGRES_PORT=5432 >> backend/.env
          echo POSTGRES_PASSWORD=postgres >> backend/.env
          echo POSTGRES_DB=mntr_db >> backend/.env
          echo FLASK_APP=app >> backend/.env
          echo FLASK_ENV=development >> backend/.env
          echo HOSTNAME=http://localhost:5000 >> backend/.env
      - name: Build the docker compose stack
        run: docker compose up -d
      - name: Check running containers
        run: docker ps -a
      - name: Generate users
      - script: |
          #!/bin/bash
          { echo "preset"; echo "exit"; } | docker exec -i mntr-backend-1 sh -c "cd tests/UserGenerator && python3 -m UserGenerator"
      - name: Run pytest
        run: pytest
      - name: Exit
        run: docker compose down

